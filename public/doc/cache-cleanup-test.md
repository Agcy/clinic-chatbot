# 对话缓存清理功能测试指南

## 🐛 问题描述
系统存在严重的缓存清理Bug：
- 用户退出训练对话后，之前的对话信息没有被删除
- 选择新对话时，错误地保留了之前对话的历史记录
- 导致对话历史泄露到新的对话会话中

## 🔧 修复方案

### 1. 增强ReturnHomeButton清理功能
- ✅ 添加全面的缓存清理逻辑
- ✅ 清理服务器端conversation_id
- ✅ 清理localStorage中的对话相关数据
- ✅ 清理全局状态和函数
- ✅ 停止音频流

### 2. 完善ChatBoxComponent清理逻辑
- ✅ 在组件销毁时清理服务器端conversation_id
- ✅ 重置所有响应式状态
- ✅ 销毁雷达图和音频资源

### 3. 添加路由守卫清理机制
- ✅ 创建全局路由守卫插件
- ✅ 检测训练页面离开时自动清理
- ✅ 跳转到主页时强制清理

### 4. 主页清理机制
- ✅ 页面加载时清理之前的对话数据
- ✅ 选择新场景前清理旧数据

## 🧪 测试步骤

### 测试场景1：训练对话退出清理
1. 进入任意训练场景（如脑外科手术）
2. 进行几轮对话，建立对话历史
3. 点击"返回主页"按钮
4. 重新选择同一个或不同的训练场景
5. **验证**: 新对话应该是空白的，没有之前的历史记录

### 测试场景2：路由切换清理
1. 进入训练对话页面
2. 进行对话建立历史记录
3. 直接在浏览器地址栏输入主页地址或使用浏览器后退
4. 重新选择训练场景
5. **验证**: 对话历史应该被清理

### 测试场景3：场景切换清理
1. 进入场景A进行对话
2. 返回主页
3. 立即选择场景B
4. **验证**: 场景B中不应该有场景A的对话记录

### 测试场景4：页面刷新清理
1. 在训练页面进行对话
2. 刷新浏览器页面
3. **验证**: 页面重新加载后对话历史应该被清理

## 🔍 验证要点

### 客户端验证
打开浏览器开发者工具，检查：
1. **localStorage**: 确认对话相关键值被清理
   - `conversationHistory`
   - `trainingProgress` 
   - `evaluationData`

2. **全局变量**: 确认以下变量被清理
   - `window.finishTraining`
   - `window.playTalkAnimation`
   - `window.onPhoneIdleStarted`
   - `window.conversationComplete`

3. **控制台日志**: 查看清理过程的日志输出
   - 🧹 开始清理消息
   - ✅ 清理完成消息
   - ❌ 清理失败警告

### 服务器端验证
检查服务器日志：
1. conversation_id清理请求
2. 清理成功/失败的响应

## 🚨 关键测试点

### 必须通过的测试
1. **对话隔离**: 不同训练会话之间完全隔离
2. **历史清理**: 退出训练后历史记录完全清除
3. **状态重置**: 所有UI状态回到初始状态
4. **内存清理**: 没有内存泄漏或残留引用

### 边界情况测试
1. **快速切换**: 快速连续切换场景
2. **网络异常**: 清理请求失败时的处理
3. **浏览器兼容**: 不同浏览器的localStorage行为
4. **移动端**: 移动设备上的清理效果

## 📊 测试结果记录

### 测试环境
- 浏览器: ___________
- 设备: ___________
- 日期: ___________

### 测试结果
- [ ] 测试场景1: 训练对话退出清理
- [ ] 测试场景2: 路由切换清理  
- [ ] 测试场景3: 场景切换清理
- [ ] 测试场景4: 页面刷新清理

### 发现的问题
1. ___________
2. ___________
3. ___________

### 修复建议
1. ___________
2. ___________
3. ___________

## 🎯 成功标准
- ✅ 所有测试场景通过
- ✅ 没有对话历史泄露
- ✅ 清理过程无错误
- ✅ 用户体验流畅
